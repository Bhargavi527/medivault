import React, { useState, useEffect } from 'react';
import { useNavigate } from 'react-router-dom';
import { toast } from 'react-toastify';
import { useAuth } from '../context/AuthContext';
import { recordsAPI } from '../api';
import AIChatbot from '../components/AIChatbot';
import QRCodeDisplay from '../components/QRCodeDisplay';
import AddRecordModal from '../components/AddRecordModal';

const RECORD_ICONS = {
  prescription: 'üíä', lab_report: 'üß™', xray: 'ü©ª', scan: 'üî¨',
  discharge_summary: 'üè•', vaccination: 'üíâ', other: 'üìÑ'
};

const RECORD_LABELS = {
  prescription: 'Prescription', lab_report: 'Lab Report', xray: 'X-Ray', scan: 'Scan',
  discharge_summary: 'Discharge Summary', vaccination: 'Vaccination', other: 'Other'
};

const NAV_ITEMS = [
  { id: 'overview', label: 'Overview', icon: 'üè†' },
  { id: 'records', label: 'Medical Records', icon: 'üìã' },
  { id: 'ai-chat', label: 'AI Health Assistant', icon: 'ü§ñ' },
  { id: 'qr-code', label: 'My QR Code', icon: 'üì±' },
  { id: 'profile', label: 'Profile', icon: 'üë§' }
];

export default function PatientDashboard() {
  const { user, logout } = useAuth();
  const navigate = useNavigate();
  const [activeTab, setActiveTab] = useState('overview');
  const [records, setRecords] = useState([]);
  const [loadingRecords, setLoadingRecords] = useState(false);
  const [showAddModal, setShowAddModal] = useState(false);

  useEffect(() => { fetchRecords(); }, []);

  const fetchRecords = async () => {
    setLoadingRecords(true);
    try {
      const { data } = await recordsAPI.getAll();
      setRecords(data.records || []);
    } catch (err) {
      toast.error('Failed to load records');
    } finally {
      setLoadingRecords(false);
    }
  };

  const handleDeleteRecord = async (id) => {
    if (!window.confirm('Delete this record?')) return;
    try {
      await recordsAPI.delete(id);
      setRecords(prev => prev.filter(r => r._id !== id));
      toast.success('Record deleted');
    } catch (err) {
      toast.error('Failed to delete record');
    }
  };

  const handleLogout = () => { logout(); navigate('/login'); };

  const recentRecords = records.slice(0, 5);
  const recordsByType = records.reduce((acc, r) => {
    acc[r.type] = (acc[r.type] || 0) + 1;
    return acc;
  }, {});

  return (
    <div className="dashboard-layout">
      {/* Sidebar */}
      <div className="sidebar">
        <div className="sidebar-header">
          <h2>üè• MediVault</h2>
          <p style={{ fontSize: '0.75rem', color: 'rgba(255,255,255,0.5)', marginTop: 4 }}>Patient Portal</p>
        </div>

        <div className="sidebar-user">
          <div className="name">{user?.name}</div>
          <div className="role-badge">Patient</div>
          {user?.bloodGroup && <div style={{ fontSize: '0.75rem', color: 'rgba(255,255,255,0.6)', marginTop: 4 }}>ü©∏ {user.bloodGroup}</div>}
        </div>

        <nav className="sidebar-nav">
          {NAV_ITEMS.map(item => (
            <button
              key={item.id}
              className={`nav-item ${activeTab === item.id ? 'active' : ''}`}
              onClick={() => setActiveTab(item.id)}
            >
              <span>{item.icon}</span>
              {item.label}
              {item.id === 'ai-chat' && <span className="ai-tag">AI</span>}
            </button>
          ))}
        </nav>

        <div className="sidebar-footer">
          <button className="nav-item" onClick={handleLogout} style={{ color: '#fca5a5' }}>
            <span>üö™</span> Sign Out
          </button>
        </div>
      </div>

      {/* Main Content */}
      <div className="main-content">
        {/* Overview Tab */}
        {activeTab === 'overview' && (
          <div className="fade-in">
            <div className="page-header">
              <h2>üëã Welcome back, {user?.name?.split(' ')[0]}!</h2>
              <p>Your health dashboard at a glance</p>
            </div>

            <div className="stats-grid">
              <div className="stat-card">
                <div className="stat-icon blue">üìã</div>
                <div className="stat-info">
                  <h4>{records.length}</h4>
                  <p>Total Records</p>
                </div>
              </div>
              <div className="stat-card">
                <div className="stat-icon green">üíä</div>
                <div className="stat-info">
                  <h4>{recordsByType.prescription || 0}</h4>
                  <p>Prescriptions</p>
                </div>
              </div>
              <div className="stat-card">
                <div className="stat-icon yellow">üß™</div>
                <div className="stat-info">
                  <h4>{recordsByType.lab_report || 0}</h4>
                  <p>Lab Reports</p>
                </div>
              </div>
              <div className="stat-card">
                <div className="stat-icon purple">üè•</div>
                <div className="stat-info">
                  <h4>{recordsByType.discharge_summary || 0}</h4>
                  <p>Discharge Summaries</p>
                </div>
              </div>
            </div>

            {/* AI Summary Promo */}
            <div className="ai-summary-card">
              <h4>ü§ñ AI Health Assistant</h4>
              <p>Get instant AI-powered summaries of your recent medical records, understand your diagnoses, and get health insights.</p>
              <button 
                onClick={() => setActiveTab('ai-chat')}
                style={{ 
                  marginTop: 12, padding: '8px 16px', background: 'rgba(255,255,255,0.2)',
                  border: '1px solid rgba(255,255,255,0.4)', color: 'white',
                  borderRadius: 8, cursor: 'pointer', fontWeight: 600, fontSize: '0.85rem'
                }}
              >
                Chat Now ‚Üí
              </button>
            </div>

            {/* Recent Records */}
            <div className="card">
              <div className="card-header">
                <h3>Recent Records</h3>
                <button className="btn btn-primary" style={{ width: 'auto', padding: '8px 16px', fontSize: '0.85rem' }} onClick={() => setShowAddModal(true)}>
                  + Add Record
                </button>
              </div>
              {recentRecords.length === 0 ? (
                <div className="empty-state">
                  <div style={{ fontSize: 48 }}>üìã</div>
                  <h4>No records yet</h4>
                  <p>Start by adding your first medical record</p>
                </div>
              ) : (
                recentRecords.map(record => (
                  <div key={record._id} className="record-card">
                    <div className="record-icon">{RECORD_ICONS[record.type] || 'üìÑ'}</div>
                    <div className="record-body">
                      <div className="record-title">{record.title}</div>
                      <div className="record-meta">
                        <span className="record-type-badge">{RECORD_LABELS[record.type]}</span>
                        {new Date(record.createdAt).toLocaleDateString()}
                        {record.doctor && ` ‚Ä¢ Dr. ${record.doctor.name}`}
                      </div>
                      {record.diagnosis && <div style={{ fontSize: '0.82rem', color: '#64748b', marginTop: 4 }}>Diagnosis: {record.diagnosis}</div>}
                    </div>
                  </div>
                ))
              )}
            </div>
          </div>
        )}

        {/* Records Tab */}
        {activeTab === 'records' && (
          <div className="fade-in">
            <div className="page-header">
              <h2>üìã Medical Records</h2>
              <p>All your health records in one place</p>
            </div>
            <div className="card">
              <div className="card-header">
                <h3>All Records ({records.length})</h3>
                <button className="btn btn-primary" style={{ width: 'auto', padding: '8px 16px', fontSize: '0.85rem' }} onClick={() => setShowAddModal(true)}>
                  + Add Record
                </button>
              </div>
              {loadingRecords && <p style={{ textAlign: 'center', padding: 20, color: '#64748b' }}>Loading...</p>}
              {!loadingRecords && records.length === 0 && (
                <div className="empty-state">
                  <div style={{ fontSize: 48 }}>üìã</div>
                  <h4>No medical records yet</h4>
                  <p>Click "Add Record" to upload your first medical document</p>
                </div>
              )}
              {records.map(record => (
                <div key={record._id} className="record-card">
                  <div className="record-icon">{RECORD_ICONS[record.type] || 'üìÑ'}</div>
                  <div className="record-body">
                    <div className="record-title">{record.title}</div>
                    <div className="record-meta">
                      <span className="record-type-badge">{RECORD_LABELS[record.type]}</span>
                      {new Date(record.createdAt).toLocaleDateString()}
                      {record.doctor && ` ‚Ä¢ Dr. ${record.doctor.name}`}
                    </div>
                    {record.diagnosis && <div style={{ fontSize: '0.82rem', color: '#64748b', marginTop: 4 }}>Diagnosis: {record.diagnosis}</div>}
                    {record.description && <div style={{ fontSize: '0.82rem', color: '#94a3b8', marginTop: 2 }}>{record.description}</div>}
                    {record.tags && record.tags.length > 0 && (
                      <div style={{ marginTop: 6, display: 'flex', gap: 4, flexWrap: 'wrap' }}>
                        {record.tags.map(tag => (
                          <span key={tag} style={{ padding: '2px 8px', background: '#f1f5f9', borderRadius: 12, fontSize: '0.72rem', color: '#64748b' }}>#{tag}</span>
                        ))}
                      </div>
                    )}
                    {record.fileUrl && (
                      <a href={`http://localhost:5000${record.fileUrl}`} target="_blank" rel="noopener noreferrer"
                        style={{ fontSize: '0.8rem', color: '#4f46e5', marginTop: 6, display: 'inline-block' }}>
                        üìé View Attachment
                      </a>
                    )}
                  </div>
                  <button className="btn btn-danger" style={{ padding: '6px 12px', fontSize: '0.8rem', flexShrink: 0 }}
                    onClick={() => handleDeleteRecord(record._id)}>
                    üóë Delete
                  </button>
                </div>
              ))}
            </div>
          </div>
        )}

        {/* AI Chat Tab */}
        {activeTab === 'ai-chat' && (
          <div className="fade-in">
            <div className="page-header">
              <h2>ü§ñ AI Health Assistant <span className="ai-tag">Powered by Claude</span></h2>
              <p>Get intelligent insights about your medical records</p>
            </div>
            <div className="card">
              <AIChatbot patientName={user?.name?.split(' ')[0]} />
            </div>
          </div>
        )}

        {/* QR Code Tab */}
        {activeTab === 'qr-code' && (
          <div className="fade-in">
            <div className="page-header">
              <h2>üì± My QR Code</h2>
              <p>Share your medical profile with doctors instantly</p>
            </div>
            <div className="card" style={{ maxWidth: 400, margin: '0 auto' }}>
              <h3 style={{ marginBottom: 20, textAlign: 'center' }}>Your Patient QR Code</h3>
              <QRCodeDisplay user={user} />
              <div style={{ marginTop: 20, padding: 16, background: '#f8fafc', borderRadius: 8, fontSize: '0.82rem', color: '#64748b' }}>
                <strong>How it works:</strong>
                <ul style={{ marginTop: 8, paddingLeft: 16 }}>
                  <li>Show this QR code to your doctor</li>
                  <li>They scan it to instantly access your medical history</li>
                  <li>No need to carry physical documents</li>
                  <li>Your privacy is protected - only verified doctors can scan</li>
                </ul>
              </div>
            </div>
          </div>
        )}

        {/* Profile Tab */}
        {activeTab === 'profile' && (
          <div className="fade-in">
            <div className="page-header">
              <h2>üë§ My Profile</h2>
              <p>Your personal information</p>
            </div>
            <div className="card" style={{ maxWidth: 500 }}>
              {[
                { label: 'Full Name', value: user?.name },
                { label: 'Email', value: user?.email },
                { label: 'Phone', value: user?.phone || 'Not provided' },
                { label: 'Blood Group', value: user?.bloodGroup || 'Not provided' },
                { label: 'Date of Birth', value: user?.dateOfBirth ? new Date(user.dateOfBirth).toLocaleDateString() : 'Not provided' },
                { label: 'Address', value: user?.address || 'Not provided' }
              ].map(item => (
                <div key={item.label} style={{ 
                  display: 'flex', justifyContent: 'space-between', padding: '12px 0',
                  borderBottom: '1px solid #f1f5f9', fontSize: '0.9rem'
                }}>
                  <span style={{ color: '#64748b', fontWeight: 500 }}>{item.label}</span>
                  <span style={{ fontWeight: 600 }}>{item.value}</span>
                </div>
              ))}
            </div>
          </div>
        )}
      </div>

      {showAddModal && (
        <AddRecordModal
          onClose={() => setShowAddModal(false)}
          onSuccess={fetchRecords}
        />
      )}
    </div>
  );
}
